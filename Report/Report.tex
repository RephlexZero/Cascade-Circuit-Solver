\documentclass[a4paper]{article}

% Packages
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage[left=2cm,right=2cm,top=2cm,bottom=2cm]{geometry}
\usepackage{fancyhdr}
\usepackage{glossaries}
\usepackage{listings}
\usepackage{xcolor} % Extended color functionalities
\usepackage{graphicx} % Required for inserting images
\usepackage{tikz}
\usetikzlibrary{automata, positioning, arrows}
\usepackage{float}
\usepackage{subcaption}

\hypersetup{colorlinks=true, linkcolor=blue}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}

\lstset{style=mystyle}

\title{Analysis and Implementation Report on Electrical Circuit Analysis Program}

\author{Jake Stewart, JS3910}
\date{\today}

\begin{document}

\begin{titlepage}
    \begin{center}
        \vspace*{1cm}

        \Huge
        \textbf{}

        \vspace{0.5cm}
        \LARGE
        Design and Implementation Report on Electrical Circuit Analysis Program\\
        EE20084 - Structured Programming
        
        \vspace{1.5cm}

        \textbf{Jake Stewart}\\
        \textbf{JS3910}\\
        \vspace{0.8cm}

        \vfill
        \includegraphics[width=0.4\textwidth]{university_logo.png}

        \Large
        Electrical and Electronic Engineering\\
        University of Bath\\
        United Kingdom\\
        \today
        

    \end{center}
\end{titlepage}

\newpage

\tableofcontents

\section{Introduction}
This report outlines the development process of an electrical circuit analysis program, as specified 
in the structured programming coursework. It aims to detail the problem analysis, design decisions, 
and testing strategies that align with the provided marking rubric.

\section{Analysis of the Problem}
The main objective of the assignment is to create a program that analyzes 
electrical circuits using two-port ABCD matrix analysis, with functionalities to read an 
input ".net" file, perform the analysis calculations, and output the results in the specified CSV format.

\subsection{Sub-tasks Identification}
\begin{itemize}
    \item Parsing the input file to extract circuit components, terminations, and desired outputs.
    \item Malformed input file handling.
    \item Translating those components into a matrix representation for analysis.
    \item Calculatinng the ABCD matrix for the circuit.
    \item Applying the ABCD matrix to the input and output terminations to obtain the desired results.
    \item Logic error handling and exception raising.
    \item Generating output files with the analysis results.
    \item Extending the program to include additional features such as exponent prefixes and decibel calculations.
\end{itemize}

\section{Module realisation and design decisions}
This section breaks down the program into modules, classes and functions, and explains the design decisions made for each.\\
The program is divided into four modules, each with a specific role:
\begin{itemize}
    \item \texttt{net\_parser.py}: Parses the input file and extracts circuit information.
    \item \texttt{circuit.py}: Contains classes and functions for circuit analysis.
    \item \texttt{csv\_writer.py}: Manages the creation and formatting of the output file with analysis results.
    \item \texttt{main.py}: The main driver script that utilizes the above modules.
\end{itemize}

From a broad view, due to the flexibale nature of the input file, the program is designed to be modular and flexible in kind. The circuit module is
designed as a class and subclass structure, with the main Circuit class containing the component array, the source and load terminations, and the output array.
The subclasses are instances of the components, terminations, and output variables which are then appended to their respective arrays to keep track of their order.
The main class has the methods to add to and sort these arrays, and to recusively reduce and invert the component matricies to obtain the ABCD termination solutions.
\\\\
The ordering of output array is then used to generate the output CSV, and it is formatted to match the provided example output files. 

\subsection{Data Structures}
This section outlines the primary data structures utilized within the main module (\texttt{main.py}), the circuit analysis module (\texttt{circuit.py}), and other modules such as the net file parser (\texttt{net\_parser.py}) and the CSV writer (\texttt{csv\_writer.py}).

\subsubsection*{Main Module (\texttt{main.py})}
The main module orchestrates the program's execution flow, leveraging the following data structures:
\begin{itemize}
    \item \textbf{Circuit Object:} An instance of the \texttt{Circuit} class from \texttt{circuit.py}, encapsulating the entire circuit's structure, including components and terminations.
    \item \textbf{Results array:} A list for the circuit's subclass of solved terminations for CSV output. 
\end{itemize}

\subsubsection*{Circuit Analysis Module (\texttt{circuit.py})}
Central to circuit analysis, this module employs:
\begin{itemize}
    \item \textbf{Circuit Class:} Contains the circuit's comprehensive data, with arrays for instances of the component, termination, and output subclasses.
    \begin{itemize}
        \item \textbf{Component List:} A list of component objects (resistors, capacitors, etc.), detailing type, value, and connections (e.g. \{\texttt{"n1"}: 1, \texttt{"n2"}: 2, \texttt{"value"}: 100, \texttt{"type"}: "R"\}).
        \item \textbf{Terminations Dictionary:} Stores the source and load terminations parameters (e.g., \{\texttt{"VT"}: 5, \texttt{"RS"}: 50\}).
        \item \textbf{Output Requirements List:} Lists the output variables as defined in the input file's order (e.g. \{\texttt{"name"}: Vin, \texttt{"unit"}: V, \texttt{"magnitude"}: m, \texttt{"is\_db"}: true\}).
    \end{itemize}
    \item \textbf{NumPy Arrays:} Employed for constructing and manipulating ABCD matrices, facilitating the numerical analysis of the electrical circuits. These arrays provide efficient handling of complex numbers and matrix operations essential for ABCD matrix calculations.
\end{itemize}

\subsubsection*{Net File Parser Module (\texttt{net\_parser.py})}
Responsible for interpreting the circuit definition file, it utilizes:
\begin{itemize}
    \item \textbf{Regular Expressions (Regex):} For identifying component definitions and extracting pertinent information.
    \item \textbf{Lists and Dictionaries:} To organize components, terminations, and output specifications for subsequent processing.
\end{itemize}

\subsubsection*{CSV Writer Module (\texttt{csv\_writer.py})}
Manages output file creation, employing:
\begin{itemize}
    \item \textbf{Lists:} To compile analysis results for output variables across specified frequencies.
    \item \textbf{File Handler:} A standard object for writing formatted results to a CSV file/tempfile.
    \item \textbf{Magnitude Lookup:} A dictionary of magnitude multipliers for converting results to the desired units (e.g., \texttt{"m"}: 1e-3, \texttt{"u"}: 1e-6).
\end{itemize}

\subsection{Functions and methods overview}

\subsection*{Input File Parsing}
The parsing of the input file is a critical initial step for the circuit analysis program,
 involving several key tasks to correctly interpret or sanatise the provided data for circuit components,
  terminations, and desired outputs. The process is outlined as follows:

\begin{enumerate}
    \item \textbf{Reading the File:} Open and read the contents of the '.net' file line-by-line, paying special attention to lines starting with the hash symbol (\#) as comments and thus skipping them during processing.
    \item \textbf{Identifying Blocks:} Systematically identify the three main blocks within the file: CIRCUIT, TERMS, and OUTPUT, each of which provides essential data for the circuit analysis.
    \item \textbf{Extracting Component Data:} Within the CIRCUIT block, extract details of each component, including node connections and component values (resistance, inductance, capacitance, or conductance).
    \item \textbf{Source and Load Termination:} From the TERMS block, determine the source and load characteristics, including type (Thevenin or Norton) and values.
    \item \textbf{Output Requirements:} In the OUTPUT block, capture the required output variables and formats, ensuring the program knows what results to calculate and how to format them.
    \item \textbf{Error Handling:} Implement robust error handling to manage potential issues in the input file, such as missing/duplicate blocks, incorrect formatting, or unsupported component types/values.
    \item \textbf{Pattern Matching:} Utilize regular expressions to identify and extract the required data from the input file, to help with resilience and flexibility in handling different input file formats.\\
    This requires that the cases where the output is in decibels or inputs/outputs with exponent prefixes are handled and stored for the extension tasks.
    \item \textbf{Storing Data:} Efficiently store the extracted information in the Circuit class module, to the respective component, termination, and output sub-classes.
\end{enumerate}

This structured approach ensures that the program can flexibly interpret and process the wide range of circuit definitions it may encounter.

\subsection*{Circuit Realization and Solving}
To realize and solve the electrical circuit defined in the input file, a systematic approach towards constructing and analyzing the circuit using the ABCD matrix method is as follows:

\begin{enumerate}
    \item \textbf{Circuit Representation:} Construct an internal representation of the circuit from the parsed data, an array of component objects, and the source and load terminations. This can then be sorted based on the node connections to facilitate the ABCD matrix construction.
    \item \textbf{Matrix Construction:} Implement functions to calculate the ABCD matrices for individual circuit elements (resistors, inductors, capacitors, and any series or parallel combinations thereof).
    \item \textbf{Cascade Handling:} A method to create a new array of 2x2 sub-ABCD matricies from the components object array, allowing for the multiplication reduction down to an individual ABCD matrix to represent the entire circuit's behavior.
    \item \textbf{Termination Analysis:} Apply the source and load terminations as defined in the TERMS block to the overall circuit matrix to determine input/output impedance and thus Vin, Iin, Vout, and Iout.
    \item \textbf{Solving the Circuit:} Utilize the inversion of the ABCD matrix of the whole circuit to solve for the desired output variables such as input/output impedance, voltage gain, and power gain.
    \item \textbf{Error and Exception Handling:} Implement comprehensive error checking and exception handling to print an empty output file with an error message if the circuit analysis fails at any stage.
    \item \textbf{Result storage:} Repeat the above and store the results for each frequency iteration in an array, to be passed to the CSV writer for output file generation.
\end{enumerate}

\subsection*{Output File Generation}
The final step in the program is to generate the output file with the calculated results. This involves the following steps:

\begin{enumerate}
    \item \textbf{CSV File Creation:} Create a new CSV file with the specified output filename and write the header row with the required output variables names and units.\\
    This also requires that the cases where the output is in decibels or with exponent prefixes are handled, and that the order of the headers matches the output array order.
    \item \textbf{Data Writing:} Write the calculated results to the CSV file, ensuring the order (as specified in the OUTPUT block and stored in the output array), 
    and the formatting (decibels, exponent prefixes) in scientific notation, are correctly applied.
    \item \textbf{File formatting:} Improve the readability of the file by padding the columns to be equal widths and aligning the values to one side, matching the provided example output files.\\
    This function should be able to operate on any CSV file.
    \item \textbf{Error Handling:} Implement error handling to write an empty output file with an error message if the output file generation fails at any stage.
\end{enumerate}
\end{document}
